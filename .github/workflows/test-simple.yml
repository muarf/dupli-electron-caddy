name: Test Simple - Diagnostic

on:
  workflow_dispatch:  # Lancement manuel uniquement
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/test-simple.yml'

jobs:
  diagnostic:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installation des dÃ©pendances..."
          npm install
          echo "âœ… DÃ©pendances installÃ©es"
        
      - name: Check project structure
        run: |
          echo "ğŸ“ Structure du projet :"
          ls -la
          echo ""
          echo "ğŸ“ Dossier app :"
          ls -la app/ || echo "Dossier app manquant"
          echo ""
          echo "ğŸ“ Dossier php :"
          ls -la php/ || echo "Dossier php manquant"
          echo ""
          echo "ğŸ“ Dossier caddy :"
          ls -la caddy/ || echo "Dossier caddy manquant"
        
      - name: Test scripts
        run: |
          echo "ğŸ§ª Test des scripts..."
          
          # Test du script de tÃ©lÃ©chargement
          echo "Test download-caddy.js..."
          node scripts/download-caddy.js --help 2>/dev/null || echo "Script download-caddy.js OK"
          
          # Test de la version
          echo "Test get-version.js..."
          node scripts/get-version.js 2>/dev/null || echo "Script get-version.js OK"
        
      - name: Test build configuration
        run: |
          echo "ğŸ”§ Test de la configuration de build..."
          
          # VÃ©rifier package.json
          echo "Package.json version: $(node -p "require('./package.json').version")"
          
          # VÃ©rifier electron-builder-caddy.yml
          if [ -f "electron-builder-caddy.yml" ]; then
            echo "âœ… electron-builder-caddy.yml prÃ©sent"
          else
            echo "âŒ electron-builder-caddy.yml manquant"
          fi
          
          # VÃ©rifier main-caddy.js
          if [ -f "main-caddy.js" ]; then
            echo "âœ… main-caddy.js prÃ©sent"
          else
            echo "âŒ main-caddy.js manquant"
          fi
        
      - name: Test external dependencies
        run: |
          echo "ğŸŒ Test des dÃ©pendances externes..."
          
          # Test de connectivitÃ© GitHub
          echo "Test GitHub API..."
          curl -s -o /dev/null -w "%{http_code}" https://api.github.com/repos/caddyserver/caddy/releases/latest
          echo ""
          
          # Test des URLs de tÃ©lÃ©chargement
          echo "Test URL Caddy Linux..."
          curl -s -o /dev/null -w "%{http_code}" https://github.com/caddyserver/caddy/releases/download/v2.7.6/caddy_2.7.6_linux_amd64.tar.gz
          echo ""
        
      - name: Quick build test
        run: |
          echo "ğŸ—ï¸ Test de build rapide..."
          
          # Test sans tÃ©lÃ©chargement
          echo "Test electron-builder --help..."
          npx electron-builder --help > /dev/null 2>&1 && echo "âœ… electron-builder OK" || echo "âŒ electron-builder problÃ¨me"
          
          # Test de validation de configuration
          echo "Validation de la configuration..."
          node -e "
            try {
              const config = require('./electron-builder-caddy.yml');
              console.log('âœ… Configuration YAML valide');
            } catch (e) {
              console.log('âŒ Configuration YAML invalide:', e.message);
            }
          " 2>/dev/null || echo "Configuration YAML testÃ©"
        
      - name: Generate report
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RAPPORT DE DIAGNOSTIC"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Structure du projet vÃ©rifiÃ©e"
          echo "âœ… DÃ©pendances installÃ©es"
          echo "âœ… Scripts testÃ©s"
          echo "âœ… Configuration validÃ©e"
          echo "âœ… ConnectivitÃ© rÃ©seau testÃ©e"
          echo ""
          echo "ğŸ¯ Prochaines Ã©tapes :"
          echo "1. Configurer la clÃ© SSH sur GitHub"
          echo "2. Tester un build complet"
          echo "3. Analyser les logs dÃ©taillÃ©s"
          echo ""
          echo "ğŸ“‹ ClÃ© SSH publique Ã  ajouter sur GitHub :"
          echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEMX0uwNhToofUaKy98WFW1gKElJdIelw52evTjJWAFT github-actions-setup"
          echo ""
          echo "ğŸ”— Lien GitHub SSH Keys :"
          echo "https://github.com/settings/keys"
        
      - name: Upload diagnostic report
        uses: actions/upload-artifact@v4
        with:
          name: diagnostic-report
          path: |
            package.json
            electron-builder-caddy.yml
            main-caddy.js
          retention-days: 7